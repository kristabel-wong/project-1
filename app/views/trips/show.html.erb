<h1><%= @trip.origin %> to <%= @trip.destination %><% if @trip.date < Time.now %> - EXPIRED <% end %> </h1> 
<h3>
<% if @trip.date.present? %><%= @trip.date.strftime '%A, %B %e' %> <%end%> <% if @trip.time.present? %> at <%= @trip.time.strftime '%l:%M %p'%> <%end%> 
</h3>

<% if @trip.image.present? %>
    <%= cl_image_tag @trip.image, :class => 'thumb' %>
<% else %>
    <%= cl_image_tag 'zpwkdm3rxbqpz3ljtd0a', :class => 'thumb' %>
<% end %>


<ul>
    <li>Price: <%= number_to_currency @trip.price, precision: 0 %></li>
    <li>Car: <%= @trip.car_make %> <%= @trip.car_model %></li>
    <li>Description: <% if @trip.description.present?%> <%= @trip.description %> <% end %></li>

</ul>

<h3>Booked:</h3>
<% @trip.bookings.each do |booking| %>
    <%= cl_image_tag booking.user.image, :class => 'user-icon'  %>
<% end %>

<% @remaining.times do  %>
    <img src="/assets/seat-icon.png" alt="seats remaining">
<% end %>


<p>
<% if @trip.user.present? %>
    <% if @current_user.present?%>
        <%= link_to user_path(@trip.user), :class => 'button' do %>
            <p>Driver: <%= @trip.user.first_name %> 
            <%= cl_image_tag @trip.user.image, :class => 'user-icon' %>
            </p>
        <% end %>
    <% else %>
        <%= link_to new_user_path(@trip.user), :class => 'button' do %>  <!-- if you want to see user, you must sign up (if not signed in) -->
            <p>Driver: <%= @trip.user.first_name %> 
            <%= cl_image_tag @trip.user.image, :class => 'user-icon' %>
            </p>
        <% end %>
    <% end %>
<% end %>
</p>

<div class="trip-add-info">
    
    <div class="booking-info">
        <div class="booked">
            <h2>Passengers</h2>
                <ul>
                    <% @trip.bookings.each do |booking| %> 
                        <li> <%= booking.user.first_name %> <% if @current_user == booking.user && booking.trip.date > Date.today %> 
                        <%= button_to 'Delete Booking', trip_booking_path(booking.trip_id, booking.id), :method => 'delete', :data => { :confirm => 'Are you sure you want to delete your booking?' } %> <% end %> 
                        </li>
                    <% end %>
                </ul>
        </div>
        <div class="button-container">
            <div class="button-bookings">
                <% if @current_user.present?%>
                    <% if @current_user.id == @trip.user.id%> <!-- only the user who created the trip can edit -->
                        <% unless @trip.date < Time.now %>
                            <button><%= link_to 'Edit Trip', edit_trip_path(@trip), :class => "button-book" %></button>
                            <%= button_to 'Delete Trip', @trip, :method => 'delete', :data => { :confirm => 'Are you sure?' }, :class => "button-book"  %>
                        <% end %>
                    <% end %>
                <% end %>

                <% if @current_user.present?%>
                    <% if @current_user.id != @trip.user.id%> <!-- only the user who created the trip can edit -->
                        <% unless @trip.bookings.count >= @trip.seat  %>
                            <%= button_to 'Book Trip', trip_bookings_path(@trip), :method => 'post', :data => { :confirm => 'Confirm booking?' }, :class => "button-book" %>
                        <% end %>
                    <% end %>
                <% end %>
            </div>
        </div>
    </div>

    <% if @current_user.present? %>
    <div class="comments">
        <div>
        <h2 class="comment-title" title="Comments are viewable to all users">Comments</h2>
        <% if @trip.comments.length != 0  %>
            <% @trip.comments.order(:created_at).reverse_order.each do |comment| %>
                <ul class="comment"> 
                    <li title=<%= comment.created_at.strftime "%e %b %y - %l:%M %p" %>> <span class="comment-user"><%= comment.user.first_name %>:</span> </li>
                    <li> <%= comment.content %>  </li>
                    <li>
                        <% if @current_user == comment.user %>
                        <button class="edit"><%= link_to '✏️', edit_comment_path(comment.trip_id,comment.id), :class => 'button' %></button> 
                        <%= button_to '🗑', comment_path(comment.trip_id,comment.id), :method => 'delete', :data => { :confirm => 'Are you sure?' }  %> 
                        <% end%>
                    </li>
                </ul>
            <% end %>
        <% end %>
        </div>
        <% if @current_user.present?%>
            <div class="button-comment"><button><%= link_to 'Add Comment', new_comment_path(@trip) %></button></div>
        <% end %>
  
    <% end %>
    </div>

</div>

<p hidden id="origin" > <%= @trip.origin %>  </p>
<p hidden id="origin-lat" > <%= Geocoder.search(@trip.origin)[0].data["lat"] %>  </p>
<p hidden id="origin-lon" > <%= Geocoder.search(@trip.origin)[0].data["lon"] %>  </p>
<p hidden id="destination" > <%= @trip.destination %>  </p>
<p hidden id="destination-lat" > <%= Geocoder.search(@trip.destination)[0].data["lat"] %>  </p>
<p hidden id="destination-lon" > <%= Geocoder.search(@trip.destination)[0].data["lon"] %>  </p>



<div id="map"></div>

<script type="text/javascript">
    let origin = document.getElementById("origin").innerText
    let originLat = parseFloat(document.getElementById("origin-lat").innerText)
    let originLon = parseFloat(document.getElementById("origin-lon").innerText)
    let destination = document.getElementById("destination").innerText
    let destinationLat = parseFloat(document.getElementById("destination-lat").innerText)
    let destinationLon = parseFloat(document.getElementById("destination-lon").innerText)

    let locations = [
      [origin, originLat, originLon, 2],
      [destination, destinationLat, destinationLon, 1]
    ];
    
    let map = new google.maps.Map(document.getElementById('map'), {
      zoom: 8,
      center: new google.maps.LatLng(originLat, originLon),
      mapTypeId: google.maps.MapTypeId.ROADMAP
    });


    let originLL = new google.maps.LatLng(originLat, originLon)
    let desintationLL = new google.maps.LatLng(destinationLat, destinationLon)

    let bounds = new google.maps.LatLngBounds();
    bounds.extend(originLL);
    bounds.extend(desintationLL);
    map.fitBounds(bounds);
    
    let infowindow = new google.maps.InfoWindow();

    let marker, i;
    
    for (i = 0; i < locations.length; i++) {  
      marker = new google.maps.Marker({
        position: new google.maps.LatLng(locations[i][1], locations[i][2]),
        map: map
      });
      
      google.maps.event.addListener(marker, 'click', (function(marker, i) {
        return function() {
          infowindow.setContent(locations[i][0]);
          infowindow.open(map, marker);
        }
      })(marker, i));
    }
  </script>
